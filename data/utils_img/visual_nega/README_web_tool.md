# 可视化数据标注器 - Web版本使用说明

## 简介

基于 **Gradio** 的 Web 版标注工具，可以在浏览器中进行数据标注，无需 X11 图形界面。

## 安装依赖

```bash
# 激活你的conda环境
conda activate qwen3vl

# 安装Gradio
pip install gradio
```

## 运行方式

```bash
cd /gpfs/projects/p32958/chengxuan/ProgressLM/data/utils_img/visual_nega
python visual_annotation_tool_web.py
```

## 访问界面

运行后会看到类似的输出：

```
🚀 启动Web服务器...

============================================================
📌 访问方式：
============================================================
1. 本地访问: http://localhost:7860
2. 远程访问: https://xxxxx.gradio.live (临时链接)
3. SSH端口转发: ssh -L 7860:localhost:7860 user@server
============================================================

Running on local URL:  http://0.0.0.0:7860
Running on public URL: https://xxxxx.gradio.live (临时链接，72小时有效)
```

### 三种访问方式

#### 方式1: 直接使用公网链接（最简单）✅ 推荐

- Gradio 会自动生成一个临时的公网链接（如 `https://xxxxx.gradio.live`）
- 直接在浏览器中打开这个链接即可
- **有效期**: 72小时
- **无需配置**: 直接就能用

#### 方式2: SSH 端口转发

如果你从本地电脑 SSH 连接到服务器：

```bash
# 在本地电脑上重新连接，添加端口转发
ssh -L 7860:localhost:7860 zux8535@qgpu2006.northwestern.edu

# 然后在服务器上运行脚本
python visual_annotation_tool_web.py

# 在本地浏览器打开
http://localhost:7860
```

#### 方式3: 直接访问服务器（如果在同一网络）

如果你的电脑和服务器在同一网络：

```bash
# 在浏览器中访问
http://qgpu2006.northwestern.edu:7860
```

## 界面功能

### 主界面布局

```
┌─────────────────────────────────────────────────────────┐
│  📝 可视化数据标注器                                     │
├─────────────────────────────────────────────────────────┤
│  ### 记录 1/6377                                        │
│  **已标注:** 0 | **YES:** 0 | **NO:** 0                │
├───────────────────────────┬─────────────────────────────┤
│  数据信息                 │  编辑后的图片                │
│                           │                             │
│  ## STRATEGY              │                             │
│  Occlusion/Removal        │      [图片显示区域]          │
│                           │                             │
│  ## PROMPT                │                             │
│  Remove the green...      │                             │
│                           │                             │
│  ## RAW DEMO              │                             │
│  [left] approaches...     │                             │
│                           │                             │
│  ## META DATA             │                             │
│  - task_goal: ...         │                             │
│  - image: camera_...jpg   │                             │
│  - text_demo:             │                             │
│    1. [left] ...          │                             │
│    2. [right] ...         │                             │
│    ...                    │                             │
├───────────────────────────┴─────────────────────────────┤
│  [⬅️ 上一条] [✅ YES] [❌ NO] [⏭️ 跳过]                  │
│  [➡️ 下一条] [💾 保存并完成]                            │
└─────────────────────────────────────────────────────────┘
```

### 按钮说明

| 按钮 | 功能 |
|------|------|
| **✅ YES (保留)** | 标注为保留，自动跳到下一条 |
| **❌ NO (删除)** | 标注为删除，自动跳到下一条 |
| **⏭️ 跳过** | 不标注，直接查看下一条 |
| **⬅️ 上一条** | 返回上一条记录 |
| **➡️ 下一条** | 查看下一条记录 |
| **💾 保存并完成** | 导出所有标注结果 |

## 功能特性

### ✅ 自动进度保存

- 每次点击 YES/NO 后自动保存进度
- 关闭浏览器后重新打开会从上次位置继续
- 进度文件：`annotation_progress.json`

### ✅ 实时统计

顶部实时显示：
- 当前记录位置（如：记录 50/6377）
- 已标注总数
- YES（保留）数量
- NO（删除）数量

### ✅ 图片自动加载

- 自动构建编辑后图片路径
- 原始图片：`camera_front_0368.jpg`
- 编辑图片：`camera_front_0368_edit.jpg`
- 图片不存在时会显示占位符

### ✅ 可修改已标注记录

- 使用"上一条/下一条"按钮浏览所有记录
- 重新点击 YES/NO 会覆盖之前的标注
- 顶部会显示当前记录的标注状态

## 输出文件

### 1. annotated_output.jsonl

包含所有标注为 **YES** 的记录：

```json
{"strategy": "Occlusion/Removal", "prompt": "...", "raw_demo": "...", "meta_data": {...}}
{"strategy": "Color Change", "prompt": "...", "raw_demo": "...", "meta_data": {...}}
...
```

### 2. annotated_output_stats.txt

详细统计信息：

```
标注统计信息
==================================================
总记录数: 6377
已标注数: 6377
YES (保留): 4520
NO (删除): 1857
未标注: 0
保留率: 70.88%
```

## 工作流程建议

1. **运行脚本**: `python visual_annotation_tool_web.py`
2. **打开浏览器**: 使用公网链接或 localhost:7860
3. **快速标注**: 主要使用 YES/NO 按钮
4. **分批处理**: 可以随时关闭，进度自动保存
5. **最终保存**: 完成后点击"保存并完成"

## 优势对比

| 特性 | tkinter版本 | Gradio版本 ✅ |
|------|------------|--------------|
| 需要X11 | ✅ 需要 | ❌ 不需要 |
| 浏览器访问 | ❌ | ✅ 支持 |
| 远程使用 | 🔸 需要X11转发 | ✅ 直接访问 |
| 界面美观 | 🔸 一般 | ✅ 现代化 |
| 移动设备 | ❌ | ✅ 支持 |
| 多人协作 | ❌ | 🔸 可能（需配置） |

## 常见问题

### Q1: 如何查看进度？

**A**: 顶部会实时显示当前位置和已标注数量。

### Q2: 可以在手机/平板上标注吗？

**A**: 可以！打开公网链接即可，界面会自动适配移动设备。

### Q3: 72小时后公网链接失效了怎么办？

**A**: 重新运行脚本会生成新的公网链接。或者使用 SSH 端口转发方式。

### Q4: 如何停止服务器？

**A**: 在运行脚本的终端按 `Ctrl+C` 即可停止。

### Q5: 多个人可以同时标注吗？

**A**: 默认情况下，多个人打开同一个链接会共享状态。如果需要独立标注，需要运行多个实例（不同端口）。

### Q6: 图片加载很慢怎么办？

**A**: 可能是网络带宽限制。如果使用公网链接，图片需要通过 Gradio 服务器中转。建议使用 SSH 端口转发方式，直接连接服务器速度更快。

## 技术参数

- **框架**: Gradio 4.x
- **端口**: 7860（默认）
- **公网链接**: 72小时有效
- **支持浏览器**: Chrome, Firefox, Safari, Edge
- **Python 版本**: >= 3.7

## 提示与技巧

### 💡 快速标注技巧

1. 使用大屏幕可以同时看到更多信息
2. 建议按类别（strategy）分批标注
3. 可以先跳过不确定的，最后再回来处理
4. 定期点击"保存并完成"备份结果

### 💡 性能优化

如果标注数据量很大（>10000条）：
1. 考虑分批处理，每次处理1000-2000条
2. 使用 SSH 端口转发而非公网链接
3. 确保服务器和你的电脑都有足够的带宽

## 故障排除

### 问题: 无法启动服务器

```bash
# 检查端口是否被占用
lsof -i :7860

# 如果被占用，可以在脚本中修改端口
# 将 server_port=7860 改为其他端口，如 server_port=8888
```

### 问题: 图片无法显示

1. 检查图片路径是否正确
2. 确认 `meta_data.id` 和 `meta_data.image` 字段存在
3. 验证文件权限是否允许读取

### 问题: 保存失败

1. 检查输出目录是否有写权限
2. 确认磁盘空间充足
3. 查看终端输出的错误信息

## 开发者信息

- **版本**: 1.0
- **最后更新**: 2025-11
- **依赖**: gradio, Pillow
- **协议**: MIT
